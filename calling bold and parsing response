# -*- coding: utf-8 -*-
"""
Created on Thu Jun 11 11:10:29 2015

@author: kirti
"""
import urllib
import urllib2
from itertools import groupby
import xml.etree.ElementTree as ET
import tabulate

def fasta_read(otus_file):
    otus = open(otus_file)
    fasta_iter = (x[1] for x in groupby(otus, lambda line: line[0] == ">"))
    otu_list = list()
    for header in fasta_iter:
        #drop >
        header = header.next()[1:].strip()
        #join all sequence lines
        seq = "".join(s.strip() for s in fasta_iter.next())
        otu_list.append(seq)
    return otu_list    
#otus_file ='otus.fasta'
#fasta_read(otus_file)

def get_bold_results():
    otus = fasta_read('otus.fasta')
    list_of_tables = list()
    for otu in otus:
        otu_xml = call_bold_api(otu)
        parsed_otu_table = xml_parser(otu_xml)
        list_of_tables.append(parsed_otu_table)
    print list_of_tables

def call_bold_api(otu):
    url_values = otu
    url = 'http://boldsystems.org/index.php/Ids_xml?db=COX1_SPECIES_PUBLIC&sequence='
    full_url = url+url_values
    data = urllib2.urlopen(full_url)
    return data

def xml_parser(otu_xml):
    tree = ET.parse(otu_xml)
    root = tree.getroot()
    table = []
    count = 0
        
    for match in root.findall('match'):
        
        ID = match.find('ID').text
        taxonomic_id=match.find('taxonomicidentification').text
        similarity=match.find('similarity').text
        url = match.find('specimen').find('url').text
        table = table + [[ID,taxonomic_id,similarity,url]]
        count = count + 1
        newcount = count
        if (count%10==0):
            print "processed "+ str(count) +" sequences"
        count = newcount   
    return table
    
get_bold_results()
